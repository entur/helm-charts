name: release

on:
  push:
    branches:
      - main

jobs:
  helm-release:
    name: helm release
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        chart: [common]

    steps:
      - name: Checkout source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Helm Release
        id: release
        uses: google-github-actions/release-please-action@v3 # not compatible with v4 - monorepo-tags is not supported
        with:
          monorepo-tags: true
          package-name: ${{ matrix.chart }}
          path: charts/${{ matrix.chart }}
          release-type: helm
          draft-pull-request: true
          extra-files: |
            README.md
            examples/common/grpc-app/Chart.yaml
            examples/common/multi-container/Chart.yaml
            examples/common/multi-deploy/Chart.yaml
            examples/common/simple-app/Chart.yaml
            examples/common/typical-backend/Chart.yaml
            examples/common/typical-frontend/Chart.yaml

      - if: ${{ steps.release.outputs.releases_created }}
        name: Publish Helm charts
        uses: stefanprodan/helm-gh-pages@0ad2bb377311d61ac04ad9eb6f252fb68e207260 # v1.7.0
        with:
          index_dir: "."
          linting: "off"
          target_dir: "archive"
          token: ${{ secrets.GITHUB_TOKEN }}

      - if: ${{ steps.release.outputs.releases_created }}
        name: Run helm-docs
        id: helm-docs
        uses: addnab/docker-run-action@4f65fabd2431ebc8d299f8e5a018d79a769ae185 # v3
        with:
          image: jnorwood/helm-docs:v1.14.2
          options: -v ${{ github.workspace }}:/helm-docs
          run: |
            helm-docs
      - if: ${{ steps.release.outputs.releases_created }}
        name: Add helm-docs changes
        id: helm-docs-changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          if [ -n "$(git status --porcelain '*.md')" ]; then
            git add **/*.md
            git commit -m "docs: update Helm chart documentation"
            git push
          else
            echo "Helm-docs are up to date"
          fi
      - if: failure()
        name: Create issue if failure
        run: |
          gh issue create --title "Auto-docs update failed" \
          --body "Auto-docs update failed, please check the logs" \
          --assignee @${{ github.actor }} --label "auto-docs"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
