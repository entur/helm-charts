suite: test secrets
values:
  - ./values/common-test-values.yaml
templates:
  - secrets.yaml
tests:
  - it: must have labels
    asserts:
      - isNotEmpty:
          path: metadata.labels
  - it: has two externalSecrets
    asserts:
      - hasDocuments:
          count: 2
  - it: must use existing secretStore
    asserts:
      - equal:
          path: spec.secretStoreRef.name
          value: rocket-test
      - equal:
          path: spec.secretStoreRef.kind
          value: SecretStore
  - it: must use correct secret name
    asserts:
      - equal:
          path: spec.target.name
          value: rocket-liftoff-one-secret
        documentIndex: 0
      - equal:
          path: spec.target.name
          value: rocket-liftoff-two-secrets
        documentIndex: 1
  - it: must use correct data references
    asserts:
      - equal:
          path: spec.data[0].secretKey
          value: ROCKET_SECRET
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.key
          value: ROCKET_SECRET
        documentIndex: 0
      - equal:
          path: spec.data[0].secretKey
          value: ROCKET_FUEL_SECRET
        documentIndex: 1
      - equal:
          path: spec.data[1].secretKey
          value: ROCKET_SCIENCE_SECRET
        documentIndex: 1
      - equal:
          path: spec.data[0].remoteRef.key
          value: ROCKET_FUEL_SECRET
        documentIndex: 1
      - equal:
          path: spec.data[1].remoteRef.key
          value: ROCKET_SCIENCE_SECRET
        documentIndex: 1

  - it: must use decodingStrategy None and default conversion strategy
    asserts:
      - equal:
          path: spec.data[0].remoteRef.decodingStrategy
          value: None
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.decodingStrategy
          value: None
        documentIndex: 1
      - equal:
          path: spec.data[1].remoteRef.decodingStrategy
          value: None
        documentIndex: 1
      - equal:
          path: spec.data[0].remoteRef.conversionStrategy
          value: Default
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.conversionStrategy
          value: Default
        documentIndex: 1
      - equal:
          path: spec.data[1].remoteRef.conversionStrategy
          value: Default
        documentIndex: 1

  - it: 1h refreshInterval
    asserts:
      - equal:
          path: spec.refreshInterval
          value: 1h
        documentIndex: 0
      - equal:
          path: spec.refreshInterval
          value: 1h
        documentIndex: 1

  - it: owner creeation policy
    asserts:
      - equal:
          path: spec.target.creationPolicy
          value: Owner
        documentIndex: 0
      - equal:
          path: spec.target.creationPolicy
          value: Owner
        documentIndex: 1

  - it: use latest secret version
    asserts:
      - equal:
          path: spec.data[0].remoteRef.version
          value: latest
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.version
          value: latest
        documentIndex: 1
      - equal:
          path: spec.data[1].remoteRef.version
          value: latest
        documentIndex: 1
  - it: should fail render secret if secret name contains dash
    set:
      secrets:
        app-secrets:
        - ROCKET-CRASH-SECRET
    asserts:
      - failedTemplate:
          errorMessage: SecretNames cannot contain dashes