# values: &values
#   env: dev
#   app: testsuite
#   shortname: tstsut
#   team: common
#   ingress:
#     host: test.dev.entur.io
#     trafficType: public

suite: test hpa
values:
  - ./values/common-test-values.yaml
templates:
  - hpa.yaml
tests:
  - it: must have labels
    set:
      env: prd
      container:
        image: img
        maxReplicas: 5
    asserts:
      - isNotEmpty:
          path: metadata.labels
  - it: default off
    set:
      container:
        image: img
    asserts:
      - hasDocuments:
          count: 0
  - it: must have minReplicas 2 if not set
    set:
      env: prd
      container:
        image: img
        maxReplicas: 5
    asserts:
      - equal:
          path: spec.minReplicas
          value: 2
  - it: use minReplicas from deployment if not set on container
    set:
      deployment:
        replicas: 4
        maxReplicas: 5
      containers:
        - image: img
    asserts:
      - equal:
          path: spec.minReplicas
          value: 4
  - it: uses 80 % as target cpu
    set:
      container:
        image: img
        maxReplicas: 5
    asserts:
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 100
  - it: must default for prd
    set:
      env: prd
      container:
        replicas: 1 # even if 1, this must be 2
        image: img
    asserts:
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10
  - it: must not use hpa if forceReplicas is set
    set:
      env: prd
      container:
        image: some
        forceReplicas: 1
    asserts:
      - hasDocuments:
          count: 0
  - it: use maxReplicas from deployment if not set on container
    set:
      env: tst # always creates HPA for prd
      deployment:
        maxReplicas: 5
      containers:
        - image: some
    asserts:
      - hasDocuments:
          count: 1
  - it: must not use hpa if forceReplicas is set on deployment
    set:
      env: prd
      deployment:
        forceReplicas: 1
      containers:
        - image: some
    asserts:
      - hasDocuments:
          count: 0
  - it: must have scaleTargetRef even if spec is given
    set:
      env: prd
      hpa:
        spec:
          metrics:
          - type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 200
    asserts:
      - isNotEmpty:
          path: spec.scaleTargetRef
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 200
  - it: can override release name
    set:
      env: prd
      releaseName: override
    asserts:
      - equal:
          path: metadata.name
          value: override
