{{- /* Rules */}}
{{- $releaseName := include "name" . -}}
{{- $releaseNamespace := .Release.Namespace -}}
{{- $forceReplicas := .Values.deployment.forceReplicas | default .Values.container.forceReplicas }}
{{- $minAvailable := .Values.deployment.minAvailable | default .Values.container.minAvailable }}
{{- $minAvailablePDB := .Values.pdb.minAvailable }}
{{- $replicas := .Values.deployment.replicas | default .Values.container.replicas }}

{{-
    /*
    We set PDB even if forceReplicas, replicas = 1,
    This is because helm is not able to delete unknown-previous config.
    In this case we set the PDB minAvailable to 0% so it behaves the same way as a PDB does not exist.
    */
}}
{{- if (or (eq (int $replicas) 1) (eq (int $forceReplicas) 1)) }}
{{- $minAvailablePDB := "0%" }}
{{- end }}

{{- /* YAML Spec */}}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ $releaseName }}
  namespace: {{ $releaseNamespace }}
  labels:
    {{- include "labels" . | indent 4 }}
spec:
  {{- /* PDB.minAvailable takes precedence over deployment/container.minAvailable */}}
  {{- if ($minAvailablePDB) }}
  minAvailable: {{ $minAvailablePDB }}
  {{- else }}
  minAvailable: {{ $minAvailable | default "50%" }}
  {{- end }}
  selector:
    matchLabels:
      app: {{ $releaseName }}
