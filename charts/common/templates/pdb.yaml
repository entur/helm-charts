{{- /* Rules */}}
{{- $releaseName := include "name" . -}}
{{- $releaseNamespace := .Release.Namespace -}}
{{- $forceReplicas := .Values.deployment.forceReplicas | default .Values.container.forceReplicas }}
{{- $minAvailable := .Values.deployment.minAvailable | default .Values.container.minAvailable }}
{{- $minAvailablePDB := .Values.pdb.minAvailable }}
{{- $replicas := .Values.deployment.replicas | default .Values.container.replicas }}

{{- /* Do not setup PDB if forceReplicas or replicas is set to 1 */}}
{{- if (and (not (eq (int $forceReplicas) 1)) (not (eq (int $replicas) 1))) }}
{{- /* YAML Spec */}}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ $releaseName }}
  namespace: {{ $releaseNamespace }}
  labels:
    {{- include "labels" . | indent 4 }}
spec:
  {{- /* PDB.minAvailable takes precedence over deployment/container.minAvailable */}}
  {{- if ($minAvailablePDB) }}
  minAvailable: {{ $minAvailablePDB }}
  {{- else }}
  minAvailable: {{ $minAvailable | default "50%" }}
  {{- end }}
  selector:
    matchLabels:
      app: {{ $releaseName }}
{{- end }}
